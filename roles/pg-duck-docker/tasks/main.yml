---
- name: Stop and remove existing pg-duck-docker container if it exists
  command: docker rm -f pg-duck-docker
  ignore_errors: yes

- name: Create /var/parquet directory on host
  file:
    path: /var/parquet
    state: directory
    mode: '0755'

- name: Set ownership for postgres user
  command: chown -R 999:999 /var/parquet

- name: Start Docker
  systemd:
    name: docker
    state: started
    enabled: yes

- name: Run pg-duck-docker container
  command: >
    docker run -d
    --name pg-duck-docker
    -e POSTGRES_PASSWORD=duckdb
    -p 5433:5432
    -v /var/parquet:/var/parquet
    pgduckdb/pgduckdb:18-v1.1.1

- name: Wait for PostgreSQL
  wait_for:
    host: localhost
    port: 5433
    delay: 10
    timeout: 120

- name: Create pg_duckdb extension
  command: >
    docker exec pg-duck-docker psql -U postgres
    -d postgres
    -c "CREATE EXTENSION IF NOT EXISTS pg_duckdb;"
  retries: 3
  delay: 5
  register: result
  until: result.rc == 0
